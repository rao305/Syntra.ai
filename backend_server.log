Warning: OpenTelemetry not available (install opentelemetry packages)
INFO:     Will watch for changes in these directories: ['/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend']
INFO:     Uvicorn running on http://0.0.0.0:8000 (Press CTRL+C to quit)
INFO:     Started reloader process [82397] using WatchFiles
Warning: OpenTelemetry not available (install opentelemetry packages)
INFO:     Started server process [82481]
INFO:     Waiting for application startup.
Warning: OpenTelemetry not available (install opentelemetry packages)
2025-12-06 11:43:52,593 INFO sqlalchemy.engine.Engine select pg_catalog.version()
2025-12-06 11:43:52,593 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-12-06 11:43:52,648 INFO sqlalchemy.engine.Engine select current_schema()
2025-12-06 11:43:52,648 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-12-06 11:43:52,671 INFO sqlalchemy.engine.Engine show standard_conforming_strings
2025-12-06 11:43:52,671 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-12-06 11:43:52,671 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-12-06 11:43:52,671 INFO sqlalchemy.engine.Engine COMMIT
INFO:     Application startup complete.
WARNING:  WatchFiles detected changes in 'init_db.py'. Reloading...
INFO:     Shutting down
INFO:     Waiting for application shutdown.
INFO:     Application shutdown complete.
INFO:     Finished server process [82481]
Python(88381) MallocStackLogging: can't turn off malloc stack logging because it was not enabled.
Warning: OpenTelemetry not available (install opentelemetry packages)
INFO:     Started server process [88381]
INFO:     Waiting for application startup.
Warning: OpenTelemetry not available (install opentelemetry packages)
2025-12-06 11:51:24,172 INFO sqlalchemy.engine.Engine select pg_catalog.version()
2025-12-06 11:51:24,173 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-12-06 11:51:24,968 INFO sqlalchemy.engine.Engine select current_schema()
2025-12-06 11:51:24,969 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-12-06 11:51:25,042 INFO sqlalchemy.engine.Engine show standard_conforming_strings
2025-12-06 11:51:25,042 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-12-06 11:51:25,084 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-12-06 11:51:25,084 INFO sqlalchemy.engine.Engine COMMIT
INFO:     Application startup complete.
WARNING:  WatchFiles detected changes in 'app/api/threads.py'. Reloading...
INFO:     Shutting down
INFO:     Waiting for application shutdown.
INFO:     Application shutdown complete.
INFO:     Finished server process [88381]
Python(88599) MallocStackLogging: can't turn off malloc stack logging because it was not enabled.
Warning: OpenTelemetry not available (install opentelemetry packages)
INFO:     Started server process [88599]
INFO:     Waiting for application startup.
Warning: OpenTelemetry not available (install opentelemetry packages)
2025-12-06 11:51:41,487 INFO sqlalchemy.engine.Engine select pg_catalog.version()
2025-12-06 11:51:41,488 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-12-06 11:51:41,570 INFO sqlalchemy.engine.Engine select current_schema()
2025-12-06 11:51:41,570 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-12-06 11:51:41,585 INFO sqlalchemy.engine.Engine show standard_conforming_strings
2025-12-06 11:51:41,585 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-12-06 11:51:41,588 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-12-06 11:51:41,588 INFO sqlalchemy.engine.Engine COMMIT
INFO:     Application startup complete.
INFO:     127.0.0.1:51970 - "OPTIONS /api/threads/f22c71e5-b61f-41a2-a673-22b9be57e6ac/messages/stream HTTP/1.1" 200 OK
[THREAD_STORE] get_thread: id='f22c71e5-b61f-41a2-a673-22b9be57e6ac', exists=False, obj_id=None, turns=0
[THREAD_STORE] get_history: no thread for id='f22c71e5-b61f-41a2-a673-22b9be57e6ac'
üîç Checking history for previous AI message. Found 0 turns
‚ö†Ô∏è  No previous assistant message found in history
‚ÑπÔ∏è  No media generation intent detected for: give me a description of the GDPR...
[THREAD_STORE] get_thread: id='f22c71e5-b61f-41a2-a673-22b9be57e6ac', exists=False, obj_id=None, turns=0
[THREAD_STORE] get_history: no thread for id='f22c71e5-b61f-41a2-a673-22b9be57e6ac'
‚úèÔ∏è  LLM rewrite: give me a description of the GDPR... ‚Üí Please give me a description of the General Data P...
   Reasoning: I replaced 'the GDPR' with its full name, 'General Data Protection Regulation', to make the query self-contained.
‚úèÔ∏è  LLM rewrite: give me a description of the GDPR... ‚Üí Please give me a description of the General Data P...
   Reasoning: 
2025-12-06 11:56:17,064 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-12-06 11:56:17,067 INFO sqlalchemy.engine.Engine SET LOCAL app.current_org_id = 'org_demo'
2025-12-06 11:56:17,067 INFO sqlalchemy.engine.Engine [generated in 0.00071s] ()
‚ö° Provider selected in 70ms -> gemini/gemini-2.5-flash
üìù LLM context-aware rewrite: 'give me a description of the GDPR...' ‚Üí 'Please give me a description of the General Data Protection Regulation (GDPR)....'
2025-12-06 11:56:17,106 INFO sqlalchemy.engine.Engine ROLLBACK
INFO:     127.0.0.1:51972 - "POST /api/threads/f22c71e5-b61f-41a2-a673-22b9be57e6ac/messages/stream HTTP/1.1" 500 Internal Server Error
ERROR:    Exception in ASGI application
Traceback (most recent call last):
  File "/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/venv/lib/python3.13/site-packages/uvicorn/protocols/http/httptools_impl.py", line 409, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        self.scope, self.receive, self.send
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/venv/lib/python3.13/site-packages/uvicorn/middleware/proxy_headers.py", line 60, in __call__
    return await self.app(scope, receive, send)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/venv/lib/python3.13/site-packages/fastapi/applications.py", line 1139, in __call__
    await super().__call__(scope, receive, send)
  File "/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/venv/lib/python3.13/site-packages/starlette/applications.py", line 107, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 191, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/Library/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/venv/lib/python3.13/site-packages/starlette/_utils.py", line 85, in collapse_excgroups
    raise exc
  File "/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 193, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/app/middleware.py", line 43, in dispatch
    response: Response = await call_next(request)
                         ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 168, in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
  File "/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/venv/lib/python3.13/site-packages/starlette/middleware/cors.py", line 93, in __call__
    await self.simple_response(scope, receive, send, request_headers=headers)
  File "/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/venv/lib/python3.13/site-packages/starlette/middleware/cors.py", line 144, in simple_response
    await self.app(scope, receive, send)
  File "/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py", line 63, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/venv/lib/python3.13/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/venv/lib/python3.13/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py", line 18, in __call__
    await self.app(scope, receive, send)
  File "/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/venv/lib/python3.13/site-packages/starlette/routing.py", line 716, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/venv/lib/python3.13/site-packages/starlette/routing.py", line 736, in app
    await route.handle(scope, receive, send)
  File "/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/venv/lib/python3.13/site-packages/starlette/routing.py", line 290, in handle
    await self.app(scope, receive, send)
  File "/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/venv/lib/python3.13/site-packages/fastapi/routing.py", line 119, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/venv/lib/python3.13/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/venv/lib/python3.13/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/venv/lib/python3.13/site-packages/fastapi/routing.py", line 105, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/venv/lib/python3.13/site-packages/fastapi/routing.py", line 385, in app
    raw_response = await run_endpoint_function(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<3 lines>...
    )
    ^
  File "/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/venv/lib/python3.13/site-packages/fastapi/routing.py", line 284, in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/app/api/threads.py", line 1401, in add_message_streaming
    await rls_task
RuntimeError: cannot reuse already awaited coroutine
[THREAD_STORE] get_thread: id='f22c71e5-b61f-41a2-a673-22b9be57e6ac', exists=False, obj_id=None, turns=0
[THREAD_STORE] get_history: no thread for id='f22c71e5-b61f-41a2-a673-22b9be57e6ac'
üîç Checking history for previous AI message. Found 0 turns
‚ö†Ô∏è  No previous assistant message found in history
‚ÑπÔ∏è  No media generation intent detected for: give me a description of what the gdpr...
[THREAD_STORE] get_thread: id='f22c71e5-b61f-41a2-a673-22b9be57e6ac', exists=False, obj_id=None, turns=0
[THREAD_STORE] get_history: no thread for id='f22c71e5-b61f-41a2-a673-22b9be57e6ac'
‚úèÔ∏è  LLM rewrite: give me a description of what the gdpr... ‚Üí Give me a description of what the General Data Pro...
   Reasoning: I replaced 'gdpr' with its full name, General Data Protection Regulation, to make the query self-contained.
‚úèÔ∏è  LLM rewrite: give me a description of what the gdpr... ‚Üí Give me a description of what the General Data Pro...
   Reasoning: 
2025-12-06 12:02:04,448 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-12-06 12:02:04,454 INFO sqlalchemy.engine.Engine SET LOCAL app.current_org_id = 'org_demo'
2025-12-06 12:02:04,455 INFO sqlalchemy.engine.Engine [cached since 347.4s ago] ()
‚ö° Provider selected in 105ms -> gemini/gemini-2.5-flash
üìù LLM context-aware rewrite: 'give me a description of what the gdpr...' ‚Üí 'Give me a description of what the General Data Protection Regulation (GDPR) is....'
2025-12-06 12:02:04,496 INFO sqlalchemy.engine.Engine ROLLBACK
INFO:     127.0.0.1:52115 - "POST /api/threads/f22c71e5-b61f-41a2-a673-22b9be57e6ac/messages/stream HTTP/1.1" 500 Internal Server Error
ERROR:    Exception in ASGI application
Traceback (most recent call last):
  File "/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/venv/lib/python3.13/site-packages/uvicorn/protocols/http/httptools_impl.py", line 409, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        self.scope, self.receive, self.send
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/venv/lib/python3.13/site-packages/uvicorn/middleware/proxy_headers.py", line 60, in __call__
    return await self.app(scope, receive, send)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/venv/lib/python3.13/site-packages/fastapi/applications.py", line 1139, in __call__
    await super().__call__(scope, receive, send)
  File "/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/venv/lib/python3.13/site-packages/starlette/applications.py", line 107, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 191, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/Library/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/venv/lib/python3.13/site-packages/starlette/_utils.py", line 85, in collapse_excgroups
    raise exc
  File "/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 193, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/app/middleware.py", line 43, in dispatch
    response: Response = await call_next(request)
                         ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 168, in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
  File "/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/venv/lib/python3.13/site-packages/starlette/middleware/cors.py", line 85, in __call__
    await self.app(scope, receive, send)
  File "/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py", line 63, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/venv/lib/python3.13/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/venv/lib/python3.13/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py", line 18, in __call__
    await self.app(scope, receive, send)
  File "/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/venv/lib/python3.13/site-packages/starlette/routing.py", line 716, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/venv/lib/python3.13/site-packages/starlette/routing.py", line 736, in app
    await route.handle(scope, receive, send)
  File "/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/venv/lib/python3.13/site-packages/starlette/routing.py", line 290, in handle
    await self.app(scope, receive, send)
  File "/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/venv/lib/python3.13/site-packages/fastapi/routing.py", line 119, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/venv/lib/python3.13/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/venv/lib/python3.13/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/venv/lib/python3.13/site-packages/fastapi/routing.py", line 105, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/venv/lib/python3.13/site-packages/fastapi/routing.py", line 385, in app
    raw_response = await run_endpoint_function(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<3 lines>...
    )
    ^
  File "/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/venv/lib/python3.13/site-packages/fastapi/routing.py", line 284, in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/app/api/threads.py", line 1401, in add_message_streaming
    await rls_task
RuntimeError: cannot reuse already awaited coroutine
/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/app/api/threads.py:1182: RuntimeWarning: coroutine 'get_api_key_for_org' was never awaited
  @router.post("/{thread_id}/messages/stream")
RuntimeWarning: Enable tracemalloc to get the object allocation traceback
[THREAD_STORE] get_thread: id='f22c71e5-b61f-41a2-a673-22b9be57e6ac', exists=False, obj_id=None, turns=0
[THREAD_STORE] get_history: no thread for id='f22c71e5-b61f-41a2-a673-22b9be57e6ac'
üîç Checking history for previous AI message. Found 0 turns
‚ö†Ô∏è  No previous assistant message found in history
‚ÑπÔ∏è  No media generation intent detected for: desrcibe to me what is gdpr...
[THREAD_STORE] get_thread: id='f22c71e5-b61f-41a2-a673-22b9be57e6ac', exists=False, obj_id=None, turns=0
[THREAD_STORE] get_history: no thread for id='f22c71e5-b61f-41a2-a673-22b9be57e6ac'
‚úèÔ∏è  LLM rewrite: desrcibe to me what is gdpr... ‚Üí Please describe to me what the General Data Protec...
   Reasoning: I replaced 'gdpr' with its full name, General Data Protection Regulation, to make the query self-contained.
‚úèÔ∏è  LLM rewrite: desrcibe to me what is gdpr... ‚Üí Please describe to me what the General Data Protec...
   Reasoning: 
2025-12-06 12:08:13,564 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-12-06 12:08:13,567 INFO sqlalchemy.engine.Engine SET LOCAL app.current_org_id = 'org_demo'
2025-12-06 12:08:13,567 INFO sqlalchemy.engine.Engine [cached since 716.5s ago] ()
‚ö° Provider selected in 36ms -> perplexity/sonar-pro
üìù LLM context-aware rewrite: 'desrcibe to me what is gdpr...' ‚Üí 'Please describe to me what the General Data Protection Regulation (GDPR) is....'
2025-12-06 12:08:13,574 INFO sqlalchemy.engine.Engine ROLLBACK
INFO:     127.0.0.1:52279 - "POST /api/threads/f22c71e5-b61f-41a2-a673-22b9be57e6ac/messages/stream HTTP/1.1" 500 Internal Server Error
ERROR:    Exception in ASGI application
Traceback (most recent call last):
  File "/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/venv/lib/python3.13/site-packages/uvicorn/protocols/http/httptools_impl.py", line 409, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        self.scope, self.receive, self.send
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/venv/lib/python3.13/site-packages/uvicorn/middleware/proxy_headers.py", line 60, in __call__
    return await self.app(scope, receive, send)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/venv/lib/python3.13/site-packages/fastapi/applications.py", line 1139, in __call__
    await super().__call__(scope, receive, send)
  File "/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/venv/lib/python3.13/site-packages/starlette/applications.py", line 107, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 191, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/Library/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/venv/lib/python3.13/site-packages/starlette/_utils.py", line 85, in collapse_excgroups
    raise exc
  File "/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 193, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/app/middleware.py", line 43, in dispatch
    response: Response = await call_next(request)
                         ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 168, in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
  File "/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/venv/lib/python3.13/site-packages/starlette/middleware/cors.py", line 85, in __call__
    await self.app(scope, receive, send)
  File "/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py", line 63, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/venv/lib/python3.13/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/venv/lib/python3.13/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py", line 18, in __call__
    await self.app(scope, receive, send)
  File "/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/venv/lib/python3.13/site-packages/starlette/routing.py", line 716, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/venv/lib/python3.13/site-packages/starlette/routing.py", line 736, in app
    await route.handle(scope, receive, send)
  File "/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/venv/lib/python3.13/site-packages/starlette/routing.py", line 290, in handle
    await self.app(scope, receive, send)
  File "/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/venv/lib/python3.13/site-packages/fastapi/routing.py", line 119, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/venv/lib/python3.13/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/venv/lib/python3.13/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/venv/lib/python3.13/site-packages/fastapi/routing.py", line 105, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/venv/lib/python3.13/site-packages/fastapi/routing.py", line 385, in app
    raw_response = await run_endpoint_function(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<3 lines>...
    )
    ^
  File "/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/venv/lib/python3.13/site-packages/fastapi/routing.py", line 284, in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/app/api/threads.py", line 1401, in add_message_streaming
    await rls_task
RuntimeError: cannot reuse already awaited coroutine
INFO:     127.0.0.1:52292 - "OPTIONS /api/threads?limit=50&archived=false HTTP/1.1" 200 OK
INFO:     127.0.0.1:52294 - "OPTIONS /api/threads?limit=50&archived=true HTTP/1.1" 200 OK
INFO:     127.0.0.1:52296 - "OPTIONS /api/threads/e5300a55-f1b0-4c42-b758-0e5e042ac61a HTTP/1.1" 200 OK
INFO:     127.0.0.1:52297 - "OPTIONS /api/threads?limit=50&archived=false HTTP/1.1" 200 OK
INFO:     127.0.0.1:52299 - "OPTIONS /api/threads?limit=50&archived=true HTTP/1.1" 200 OK
INFO:     127.0.0.1:52299 - "GET /api/threads?limit=50&archived=false HTTP/1.1" 307 Temporary Redirect
INFO:     127.0.0.1:52297 - "GET /api/threads?limit=50&archived=true HTTP/1.1" 307 Temporary Redirect
INFO:     127.0.0.1:52294 - "GET /api/threads?limit=50&archived=false HTTP/1.1" 307 Temporary Redirect
INFO:     127.0.0.1:52292 - "GET /api/threads?limit=50&archived=true HTTP/1.1" 307 Temporary Redirect
INFO:     127.0.0.1:52292 - "OPTIONS /api/threads/?limit=50&archived=false HTTP/1.1" 200 OK
INFO:     127.0.0.1:52292 - "OPTIONS /api/threads/?limit=50&archived=true HTTP/1.1" 200 OK
INFO:     127.0.0.1:52294 - "OPTIONS /api/threads/?limit=50&archived=false HTTP/1.1" 200 OK
INFO:     127.0.0.1:52297 - "OPTIONS /api/threads/?limit=50&archived=true HTTP/1.1" 200 OK
2025-12-06 12:08:25,460 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-12-06 12:08:25,465 INFO sqlalchemy.engine.Engine SET LOCAL app.current_org_id = 'org_demo'
2025-12-06 12:08:25,465 INFO sqlalchemy.engine.Engine [cached since 728.4s ago] ()
2025-12-06 12:08:25,844 INFO sqlalchemy.engine.Engine SELECT threads.id, threads.org_id, threads.creator_id, threads.title, threads.description, threads.last_message_preview, threads.pinned, threads.archived, threads.archived_at, threads.settings, threads.last_provider, threads.last_model, threads.created_at, threads.updated_at 
FROM threads 
WHERE threads.id = $1::VARCHAR AND threads.org_id = $2::VARCHAR
2025-12-06 12:08:25,844 INFO sqlalchemy.engine.Engine [generated in 0.00079s] ('e5300a55-f1b0-4c42-b758-0e5e042ac61a', 'org_demo')
2025-12-06 12:08:26,730 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-12-06 12:08:26,731 INFO sqlalchemy.engine.Engine SET LOCAL app.current_org_id = 'org_demo'
2025-12-06 12:08:26,731 INFO sqlalchemy.engine.Engine [cached since 729.6s ago] ()
2025-12-06 12:08:26,733 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-12-06 12:08:26,734 INFO sqlalchemy.engine.Engine SET LOCAL app.current_org_id = 'org_demo'
2025-12-06 12:08:26,734 INFO sqlalchemy.engine.Engine [cached since 729.6s ago] ()
2025-12-06 12:08:26,870 INFO sqlalchemy.engine.Engine SELECT threads.id, threads.org_id, threads.creator_id, threads.title, threads.description, threads.last_message_preview, threads.pinned, threads.archived, threads.archived_at, threads.settings, threads.last_provider, threads.last_model, threads.created_at, threads.updated_at 
FROM threads 
WHERE threads.org_id = $1::VARCHAR AND threads.archived = false ORDER BY threads.updated_at DESC NULLS LAST, threads.created_at DESC 
 LIMIT $2::INTEGER
2025-12-06 12:08:26,870 INFO sqlalchemy.engine.Engine [generated in 0.00104s] ('org_demo', 50)
2025-12-06 12:08:26,873 INFO sqlalchemy.engine.Engine SELECT threads.id, threads.org_id, threads.creator_id, threads.title, threads.description, threads.last_message_preview, threads.pinned, threads.archived, threads.archived_at, threads.settings, threads.last_provider, threads.last_model, threads.created_at, threads.updated_at 
FROM threads 
WHERE threads.org_id = $1::VARCHAR AND threads.archived = true ORDER BY threads.updated_at DESC NULLS LAST, threads.created_at DESC 
 LIMIT $2::INTEGER
2025-12-06 12:08:26,873 INFO sqlalchemy.engine.Engine [generated in 0.00010s] ('org_demo', 50)
2025-12-06 12:08:28,082 INFO sqlalchemy.engine.Engine SELECT messages.id, messages.thread_id, messages.user_id, messages.role, messages.content, messages.encrypted_content, messages.encryption_key_id, messages.provider, messages.model, messages.provider_message_id, messages.meta, messages.prompt_tokens, messages.completion_tokens, messages.total_tokens, messages.citations, messages.sequence, messages.created_at 
FROM messages 
WHERE messages.thread_id = $1::VARCHAR ORDER BY messages.sequence
2025-12-06 12:08:28,157 INFO sqlalchemy.engine.Engine [generated in 0.07522s] ('e5300a55-f1b0-4c42-b758-0e5e042ac61a',)
INFO:     127.0.0.1:52297 - "GET /api/threads/?limit=50&archived=true HTTP/1.1" 200 OK
INFO:     127.0.0.1:52292 - "GET /api/threads/?limit=50&archived=false HTTP/1.1" 200 OK
2025-12-06 12:08:28,219 INFO sqlalchemy.engine.Engine ROLLBACK
2025-12-06 12:08:28,219 INFO sqlalchemy.engine.Engine ROLLBACK
2025-12-06 12:08:28,840 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-12-06 12:08:28,847 INFO sqlalchemy.engine.Engine SET LOCAL app.current_org_id = 'org_demo'
2025-12-06 12:08:28,849 INFO sqlalchemy.engine.Engine [cached since 731.8s ago] ()
2025-12-06 12:08:28,856 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-12-06 12:08:28,857 INFO sqlalchemy.engine.Engine SET LOCAL app.current_org_id = 'org_demo'
2025-12-06 12:08:28,857 INFO sqlalchemy.engine.Engine [cached since 731.8s ago] ()
2025-12-06 12:08:28,869 INFO sqlalchemy.engine.Engine SELECT threads.id, threads.org_id, threads.creator_id, threads.title, threads.description, threads.last_message_preview, threads.pinned, threads.archived, threads.archived_at, threads.settings, threads.last_provider, threads.last_model, threads.created_at, threads.updated_at 
FROM threads 
WHERE threads.org_id = $1::VARCHAR AND threads.archived = false ORDER BY threads.updated_at DESC NULLS LAST, threads.created_at DESC 
 LIMIT $2::INTEGER
2025-12-06 12:08:28,870 INFO sqlalchemy.engine.Engine [cached since 2.001s ago] ('org_demo', 50)
2025-12-06 12:08:28,871 INFO sqlalchemy.engine.Engine SELECT threads.id, threads.org_id, threads.creator_id, threads.title, threads.description, threads.last_message_preview, threads.pinned, threads.archived, threads.archived_at, threads.settings, threads.last_provider, threads.last_model, threads.created_at, threads.updated_at 
FROM threads 
WHERE threads.org_id = $1::VARCHAR AND threads.archived = true ORDER BY threads.updated_at DESC NULLS LAST, threads.created_at DESC 
 LIMIT $2::INTEGER
2025-12-06 12:08:28,872 INFO sqlalchemy.engine.Engine [cached since 1.999s ago] ('org_demo', 50)
INFO:     127.0.0.1:52299 - "GET /api/threads/?limit=50&archived=true HTTP/1.1" 200 OK
INFO:     127.0.0.1:52294 - "GET /api/threads/?limit=50&archived=false HTTP/1.1" 200 OK
2025-12-06 12:08:29,172 INFO sqlalchemy.engine.Engine ROLLBACK
2025-12-06 12:08:29,174 INFO sqlalchemy.engine.Engine ROLLBACK
INFO:     127.0.0.1:52296 - "GET /api/threads/e5300a55-f1b0-4c42-b758-0e5e042ac61a HTTP/1.1" 200 OK
2025-12-06 12:08:29,864 INFO sqlalchemy.engine.Engine ROLLBACK
INFO:     127.0.0.1:52309 - "GET /api/threads?limit=50&archived=false HTTP/1.1" 307 Temporary Redirect
INFO:     127.0.0.1:52312 - "GET /api/threads?limit=50&archived=true HTTP/1.1" 307 Temporary Redirect
INFO:     127.0.0.1:52313 - "OPTIONS /api/threads/229d353c-64d4-4f0e-bdbd-56d44878d0fb HTTP/1.1" 200 OK
INFO:     127.0.0.1:52315 - "GET /api/threads?limit=50&archived=false HTTP/1.1" 307 Temporary Redirect
INFO:     127.0.0.1:52317 - "GET /api/threads?limit=50&archived=true HTTP/1.1" 307 Temporary Redirect
2025-12-06 12:08:44,468 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-12-06 12:08:44,470 INFO sqlalchemy.engine.Engine SET LOCAL app.current_org_id = 'org_demo'
2025-12-06 12:08:44,471 INFO sqlalchemy.engine.Engine [cached since 747.4s ago] ()
2025-12-06 12:08:44,483 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-12-06 12:08:44,483 INFO sqlalchemy.engine.Engine SET LOCAL app.current_org_id = 'org_demo'
2025-12-06 12:08:44,483 INFO sqlalchemy.engine.Engine [cached since 747.4s ago] ()
2025-12-06 12:08:44,490 INFO sqlalchemy.engine.Engine SELECT threads.id, threads.org_id, threads.creator_id, threads.title, threads.description, threads.last_message_preview, threads.pinned, threads.archived, threads.archived_at, threads.settings, threads.last_provider, threads.last_model, threads.created_at, threads.updated_at 
FROM threads 
WHERE threads.org_id = $1::VARCHAR AND threads.archived = false ORDER BY threads.updated_at DESC NULLS LAST, threads.created_at DESC 
 LIMIT $2::INTEGER
2025-12-06 12:08:44,490 INFO sqlalchemy.engine.Engine [cached since 17.62s ago] ('org_demo', 50)
2025-12-06 12:08:44,491 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-12-06 12:08:44,491 INFO sqlalchemy.engine.Engine SET LOCAL app.current_org_id = 'org_demo'
2025-12-06 12:08:44,491 INFO sqlalchemy.engine.Engine [cached since 747.4s ago] ()
2025-12-06 12:08:44,493 INFO sqlalchemy.engine.Engine SELECT threads.id, threads.org_id, threads.creator_id, threads.title, threads.description, threads.last_message_preview, threads.pinned, threads.archived, threads.archived_at, threads.settings, threads.last_provider, threads.last_model, threads.created_at, threads.updated_at 
FROM threads 
WHERE threads.id = $1::VARCHAR AND threads.org_id = $2::VARCHAR
2025-12-06 12:08:44,493 INFO sqlalchemy.engine.Engine [cached since 18.65s ago] ('229d353c-64d4-4f0e-bdbd-56d44878d0fb', 'org_demo')
2025-12-06 12:08:44,495 INFO sqlalchemy.engine.Engine SELECT threads.id, threads.org_id, threads.creator_id, threads.title, threads.description, threads.last_message_preview, threads.pinned, threads.archived, threads.archived_at, threads.settings, threads.last_provider, threads.last_model, threads.created_at, threads.updated_at 
FROM threads 
WHERE threads.org_id = $1::VARCHAR AND threads.archived = true ORDER BY threads.updated_at DESC NULLS LAST, threads.created_at DESC 
 LIMIT $2::INTEGER
2025-12-06 12:08:44,495 INFO sqlalchemy.engine.Engine [cached since 17.62s ago] ('org_demo', 50)
2025-12-06 12:08:44,499 INFO sqlalchemy.engine.Engine SELECT messages.id, messages.thread_id, messages.user_id, messages.role, messages.content, messages.encrypted_content, messages.encryption_key_id, messages.provider, messages.model, messages.provider_message_id, messages.meta, messages.prompt_tokens, messages.completion_tokens, messages.total_tokens, messages.citations, messages.sequence, messages.created_at 
FROM messages 
WHERE messages.thread_id = $1::VARCHAR ORDER BY messages.sequence
2025-12-06 12:08:44,499 INFO sqlalchemy.engine.Engine [cached since 16.42s ago] ('229d353c-64d4-4f0e-bdbd-56d44878d0fb',)
INFO:     127.0.0.1:52309 - "GET /api/threads/?limit=50&archived=false HTTP/1.1" 200 OK
INFO:     127.0.0.1:52312 - "GET /api/threads/?limit=50&archived=true HTTP/1.1" 200 OK
2025-12-06 12:08:44,501 INFO sqlalchemy.engine.Engine ROLLBACK
2025-12-06 12:08:44,502 INFO sqlalchemy.engine.Engine ROLLBACK
2025-12-06 12:08:44,507 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-12-06 12:08:44,507 INFO sqlalchemy.engine.Engine SET LOCAL app.current_org_id = 'org_demo'
2025-12-06 12:08:44,507 INFO sqlalchemy.engine.Engine [cached since 747.4s ago] ()
2025-12-06 12:08:44,508 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-12-06 12:08:44,508 INFO sqlalchemy.engine.Engine SET LOCAL app.current_org_id = 'org_demo'
2025-12-06 12:08:44,508 INFO sqlalchemy.engine.Engine [cached since 747.4s ago] ()
2025-12-06 12:08:44,509 INFO sqlalchemy.engine.Engine SELECT threads.id, threads.org_id, threads.creator_id, threads.title, threads.description, threads.last_message_preview, threads.pinned, threads.archived, threads.archived_at, threads.settings, threads.last_provider, threads.last_model, threads.created_at, threads.updated_at 
FROM threads 
WHERE threads.org_id = $1::VARCHAR AND threads.archived = false ORDER BY threads.updated_at DESC NULLS LAST, threads.created_at DESC 
 LIMIT $2::INTEGER
2025-12-06 12:08:44,509 INFO sqlalchemy.engine.Engine [cached since 17.64s ago] ('org_demo', 50)
INFO:     127.0.0.1:52317 - "GET /api/threads/?limit=50&archived=false HTTP/1.1" 200 OK
2025-12-06 12:08:44,511 INFO sqlalchemy.engine.Engine ROLLBACK
2025-12-06 12:08:44,519 INFO sqlalchemy.engine.Engine SELECT threads.id, threads.org_id, threads.creator_id, threads.title, threads.description, threads.last_message_preview, threads.pinned, threads.archived, threads.archived_at, threads.settings, threads.last_provider, threads.last_model, threads.created_at, threads.updated_at 
FROM threads 
WHERE threads.org_id = $1::VARCHAR AND threads.archived = true ORDER BY threads.updated_at DESC NULLS LAST, threads.created_at DESC 
 LIMIT $2::INTEGER
2025-12-06 12:08:44,519 INFO sqlalchemy.engine.Engine [cached since 17.65s ago] ('org_demo', 50)
INFO:     127.0.0.1:52315 - "GET /api/threads/?limit=50&archived=true HTTP/1.1" 200 OK
2025-12-06 12:08:44,568 INFO sqlalchemy.engine.Engine ROLLBACK
INFO:     127.0.0.1:52313 - "GET /api/threads/229d353c-64d4-4f0e-bdbd-56d44878d0fb HTTP/1.1" 200 OK
2025-12-06 12:08:44,589 INFO sqlalchemy.engine.Engine ROLLBACK
INFO:     127.0.0.1:52313 - "GET /api/threads?limit=50&archived=false HTTP/1.1" 307 Temporary Redirect
INFO:     127.0.0.1:52315 - "GET /api/threads?limit=50&archived=true HTTP/1.1" 307 Temporary Redirect
2025-12-06 12:08:49,567 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-12-06 12:08:49,595 INFO sqlalchemy.engine.Engine SET LOCAL app.current_org_id = 'org_demo'
2025-12-06 12:08:49,599 INFO sqlalchemy.engine.Engine [cached since 752.5s ago] ()
INFO:     127.0.0.1:52321 - "GET /api/threads?limit=50&archived=false HTTP/1.1" 307 Temporary Redirect
INFO:     127.0.0.1:52323 - "GET /api/threads?limit=50&archived=true HTTP/1.1" 307 Temporary Redirect
2025-12-06 12:08:49,657 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-12-06 12:08:49,658 INFO sqlalchemy.engine.Engine SET LOCAL app.current_org_id = 'org_demo'
2025-12-06 12:08:49,658 INFO sqlalchemy.engine.Engine [cached since 752.6s ago] ()
2025-12-06 12:08:49,721 INFO sqlalchemy.engine.Engine SELECT threads.id, threads.org_id, threads.creator_id, threads.title, threads.description, threads.last_message_preview, threads.pinned, threads.archived, threads.archived_at, threads.settings, threads.last_provider, threads.last_model, threads.created_at, threads.updated_at 
FROM threads 
WHERE threads.org_id = $1::VARCHAR AND threads.archived = true ORDER BY threads.updated_at DESC NULLS LAST, threads.created_at DESC 
 LIMIT $2::INTEGER
2025-12-06 12:08:49,722 INFO sqlalchemy.engine.Engine [cached since 22.85s ago] ('org_demo', 50)
2025-12-06 12:08:49,725 INFO sqlalchemy.engine.Engine SELECT threads.id, threads.org_id, threads.creator_id, threads.title, threads.description, threads.last_message_preview, threads.pinned, threads.archived, threads.archived_at, threads.settings, threads.last_provider, threads.last_model, threads.created_at, threads.updated_at 
FROM threads 
WHERE threads.org_id = $1::VARCHAR AND threads.archived = false ORDER BY threads.updated_at DESC NULLS LAST, threads.created_at DESC 
 LIMIT $2::INTEGER
2025-12-06 12:08:49,725 INFO sqlalchemy.engine.Engine [cached since 22.86s ago] ('org_demo', 50)
INFO:     127.0.0.1:52315 - "GET /api/threads/?limit=50&archived=false HTTP/1.1" 200 OK
INFO:     127.0.0.1:52313 - "GET /api/threads/?limit=50&archived=true HTTP/1.1" 200 OK
2025-12-06 12:08:49,893 INFO sqlalchemy.engine.Engine ROLLBACK
2025-12-06 12:08:49,893 INFO sqlalchemy.engine.Engine ROLLBACK
2025-12-06 12:08:50,057 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-12-06 12:08:50,059 INFO sqlalchemy.engine.Engine SET LOCAL app.current_org_id = 'org_demo'
2025-12-06 12:08:50,059 INFO sqlalchemy.engine.Engine [cached since 753s ago] ()
2025-12-06 12:08:50,061 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-12-06 12:08:50,061 INFO sqlalchemy.engine.Engine SET LOCAL app.current_org_id = 'org_demo'
2025-12-06 12:08:50,061 INFO sqlalchemy.engine.Engine [cached since 753s ago] ()
2025-12-06 12:08:50,067 INFO sqlalchemy.engine.Engine SELECT threads.id, threads.org_id, threads.creator_id, threads.title, threads.description, threads.last_message_preview, threads.pinned, threads.archived, threads.archived_at, threads.settings, threads.last_provider, threads.last_model, threads.created_at, threads.updated_at 
FROM threads 
WHERE threads.org_id = $1::VARCHAR AND threads.archived = true ORDER BY threads.updated_at DESC NULLS LAST, threads.created_at DESC 
 LIMIT $2::INTEGER
2025-12-06 12:08:50,067 INFO sqlalchemy.engine.Engine [cached since 23.19s ago] ('org_demo', 50)
2025-12-06 12:08:50,070 INFO sqlalchemy.engine.Engine SELECT threads.id, threads.org_id, threads.creator_id, threads.title, threads.description, threads.last_message_preview, threads.pinned, threads.archived, threads.archived_at, threads.settings, threads.last_provider, threads.last_model, threads.created_at, threads.updated_at 
FROM threads 
WHERE threads.org_id = $1::VARCHAR AND threads.archived = false ORDER BY threads.updated_at DESC NULLS LAST, threads.created_at DESC 
 LIMIT $2::INTEGER
2025-12-06 12:08:50,073 INFO sqlalchemy.engine.Engine [cached since 23.2s ago] ('org_demo', 50)
INFO:     127.0.0.1:52323 - "GET /api/threads/?limit=50&archived=false HTTP/1.1" 200 OK
2025-12-06 12:08:50,080 INFO sqlalchemy.engine.Engine ROLLBACK
INFO:     127.0.0.1:52321 - "GET /api/threads/?limit=50&archived=true HTTP/1.1" 200 OK
2025-12-06 12:08:50,168 INFO sqlalchemy.engine.Engine ROLLBACK
INFO:     127.0.0.1:52333 - "OPTIONS /api/threads/ HTTP/1.1" 200 OK
2025-12-06 12:09:16,165 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-12-06 12:09:16,217 INFO sqlalchemy.engine.Engine SET LOCAL app.current_org_id = 'org_demo'
2025-12-06 12:09:16,223 INFO sqlalchemy.engine.Engine [cached since 779.1s ago] ()
2025-12-06 12:09:16,990 INFO sqlalchemy.engine.Engine INSERT INTO threads (id, org_id, creator_id, title, description, last_message_preview, pinned, archived, archived_at, last_provider, last_model) VALUES ($1::VARCHAR, $2::VARCHAR, $3::VARCHAR, $4::VARCHAR, $5::VARCHAR, $6::VARCHAR, $7::BOOLEAN, $8::BOOLEAN, $9::TIMESTAMP WITH TIME ZONE, $10::VARCHAR, $11::VARCHAR) RETURNING threads.created_at, threads.updated_at
2025-12-06 12:09:16,992 INFO sqlalchemy.engine.Engine [generated in 0.04323s] ('c47d490a-a4de-4dc0-9d06-5f8a0f4d650b', 'org_demo', None, 'what is gdpr', '', None, False, False, None, None, None)
2025-12-06 12:09:21,683 INFO sqlalchemy.engine.Engine COMMIT
2025-12-06 12:09:21,919 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-12-06 12:09:21,939 INFO sqlalchemy.engine.Engine SELECT threads.id, threads.org_id, threads.creator_id, threads.title, threads.description, threads.last_message_preview, threads.pinned, threads.archived, threads.archived_at, threads.settings, threads.last_provider, threads.last_model, threads.created_at, threads.updated_at 
FROM threads 
WHERE threads.id = $1::VARCHAR
2025-12-06 12:09:21,939 INFO sqlalchemy.engine.Engine [generated in 0.00020s] ('c47d490a-a4de-4dc0-9d06-5f8a0f4d650b',)
INFO:     127.0.0.1:52333 - "POST /api/threads/ HTTP/1.1" 200 OK
2025-12-06 12:09:22,249 INFO sqlalchemy.engine.Engine ROLLBACK
INFO:     127.0.0.1:52333 - "OPTIONS /api/threads/c47d490a-a4de-4dc0-9d06-5f8a0f4d650b/messages HTTP/1.1" 200 OK
üîç DEBUG: add_message called - collaboration_mode=False, content=what is gdpr...
2025-12-06 12:09:22,632 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-12-06 12:09:22,633 INFO sqlalchemy.engine.Engine SET LOCAL app.current_org_id = 'org_demo'
2025-12-06 12:09:22,633 INFO sqlalchemy.engine.Engine [cached since 785.5s ago] ()
2025-12-06 12:09:23,309 INFO sqlalchemy.engine.Engine SELECT threads.id, threads.org_id, threads.creator_id, threads.title, threads.description, threads.last_message_preview, threads.pinned, threads.archived, threads.archived_at, threads.settings, threads.last_provider, threads.last_model, threads.created_at, threads.updated_at 
FROM threads 
WHERE threads.id = $1::VARCHAR AND threads.org_id = $2::VARCHAR
2025-12-06 12:09:23,310 INFO sqlalchemy.engine.Engine [cached since 57.47s ago] ('c47d490a-a4de-4dc0-9d06-5f8a0f4d650b', 'org_demo')
2025-12-06 12:09:23,474 INFO sqlalchemy.engine.Engine SELECT orgs.id, orgs.name, orgs.slug, orgs.stripe_customer_id, orgs.stripe_subscription_id, orgs.subscription_status, orgs.seats_licensed, orgs.seats_used, orgs.requests_per_day, orgs.tokens_per_day, orgs.sso_enabled, orgs.saml_metadata_url, orgs.created_at, orgs.updated_at 
FROM orgs 
WHERE orgs.id = $1::VARCHAR
2025-12-06 12:09:23,474 INFO sqlalchemy.engine.Engine [generated in 0.00020s] ('org_demo',)
2025-12-06 12:09:23,853 INFO sqlalchemy.engine.Engine SELECT messages.id, messages.thread_id, messages.user_id, messages.role, messages.content, messages.encrypted_content, messages.encryption_key_id, messages.provider, messages.model, messages.provider_message_id, messages.meta, messages.prompt_tokens, messages.completion_tokens, messages.total_tokens, messages.citations, messages.sequence, messages.created_at 
FROM messages 
WHERE messages.thread_id = $1::VARCHAR ORDER BY messages.sequence DESC 
 LIMIT $2::INTEGER
2025-12-06 12:09:23,853 INFO sqlalchemy.engine.Engine [generated in 0.00082s] ('c47d490a-a4de-4dc0-9d06-5f8a0f4d650b', 20)
INFO:     127.0.0.1:52341 - "GET /api/threads?limit=50&archived=false HTTP/1.1" 307 Temporary Redirect
INFO:     127.0.0.1:52344 - "GET /api/threads?limit=50&archived=true HTTP/1.1" 307 Temporary Redirect
INFO:     127.0.0.1:52345 - "OPTIONS /api/threads/c47d490a-a4de-4dc0-9d06-5f8a0f4d650b HTTP/1.1" 200 OK
INFO:     127.0.0.1:52347 - "GET /api/threads?limit=50&archived=false HTTP/1.1" 307 Temporary Redirect
INFO:     127.0.0.1:52341 - "GET /api/threads?limit=50&archived=true HTTP/1.1" 307 Temporary Redirect
2025-12-06 12:09:24,589 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-12-06 12:09:24,589 INFO sqlalchemy.engine.Engine SET LOCAL app.current_org_id = 'org_demo'
2025-12-06 12:09:24,589 INFO sqlalchemy.engine.Engine [cached since 787.5s ago] ()
2025-12-06 12:09:24,622 INFO sqlalchemy.engine.Engine SELECT threads.id, threads.org_id, threads.creator_id, threads.title, threads.description, threads.last_message_preview, threads.pinned, threads.archived, threads.archived_at, threads.settings, threads.last_provider, threads.last_model, threads.created_at, threads.updated_at 
FROM threads 
WHERE threads.org_id = $1::VARCHAR AND threads.archived = true ORDER BY threads.updated_at DESC NULLS LAST, threads.created_at DESC 
 LIMIT $2::INTEGER
2025-12-06 12:09:24,622 INFO sqlalchemy.engine.Engine [cached since 57.75s ago] ('org_demo', 50)
2025-12-06 12:09:24,646 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-12-06 12:09:24,646 INFO sqlalchemy.engine.Engine SET LOCAL app.current_org_id = 'org_demo'
2025-12-06 12:09:24,646 INFO sqlalchemy.engine.Engine [cached since 787.6s ago] ()
2025-12-06 12:09:24,647 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-12-06 12:09:24,647 INFO sqlalchemy.engine.Engine SET LOCAL app.current_org_id = 'org_demo'
2025-12-06 12:09:24,647 INFO sqlalchemy.engine.Engine [cached since 787.6s ago] ()
2025-12-06 12:09:24,674 INFO sqlalchemy.engine.Engine SELECT threads.id, threads.org_id, threads.creator_id, threads.title, threads.description, threads.last_message_preview, threads.pinned, threads.archived, threads.archived_at, threads.settings, threads.last_provider, threads.last_model, threads.created_at, threads.updated_at 
FROM threads 
WHERE threads.org_id = $1::VARCHAR AND threads.archived = false ORDER BY threads.updated_at DESC NULLS LAST, threads.created_at DESC 
 LIMIT $2::INTEGER
2025-12-06 12:09:24,674 INFO sqlalchemy.engine.Engine [cached since 57.8s ago] ('org_demo', 50)
2025-12-06 12:09:24,676 INFO sqlalchemy.engine.Engine SELECT threads.id, threads.org_id, threads.creator_id, threads.title, threads.description, threads.last_message_preview, threads.pinned, threads.archived, threads.archived_at, threads.settings, threads.last_provider, threads.last_model, threads.created_at, threads.updated_at 
FROM threads 
WHERE threads.id = $1::VARCHAR AND threads.org_id = $2::VARCHAR
2025-12-06 12:09:24,676 INFO sqlalchemy.engine.Engine [cached since 58.83s ago] ('c47d490a-a4de-4dc0-9d06-5f8a0f4d650b', 'org_demo')
2025-12-06 12:09:24,732 INFO sqlalchemy.engine.Engine SELECT provider_keys.id, provider_keys.org_id, provider_keys.provider, provider_keys.encrypted_key, provider_keys.key_name, provider_keys.last_used, provider_keys.is_active, provider_keys.created_at, provider_keys.updated_at 
FROM provider_keys 
WHERE provider_keys.org_id = $1::VARCHAR AND provider_keys.is_active = $2::VARCHAR
2025-12-06 12:09:24,732 INFO sqlalchemy.engine.Engine [generated in 0.00025s] ('org_demo', 'true')
INFO:     127.0.0.1:52344 - "GET /api/threads/?limit=50&archived=true HTTP/1.1" 200 OK
2025-12-06 12:09:24,736 INFO sqlalchemy.engine.Engine ROLLBACK
2025-12-06 12:09:24,814 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-12-06 12:09:24,814 INFO sqlalchemy.engine.Engine SET LOCAL app.current_org_id = 'org_demo'
2025-12-06 12:09:24,814 INFO sqlalchemy.engine.Engine [cached since 787.7s ago] ()
2025-12-06 12:09:24,842 INFO sqlalchemy.engine.Engine SELECT threads.id, threads.org_id, threads.creator_id, threads.title, threads.description, threads.last_message_preview, threads.pinned, threads.archived, threads.archived_at, threads.settings, threads.last_provider, threads.last_model, threads.created_at, threads.updated_at 
FROM threads 
WHERE threads.org_id = $1::VARCHAR AND threads.archived = true ORDER BY threads.updated_at DESC NULLS LAST, threads.created_at DESC 
 LIMIT $2::INTEGER
2025-12-06 12:09:24,842 INFO sqlalchemy.engine.Engine [cached since 57.97s ago] ('org_demo', 50)
2025-12-06 12:09:24,853 INFO sqlalchemy.engine.Engine SELECT messages.id, messages.thread_id, messages.user_id, messages.role, messages.content, messages.encrypted_content, messages.encryption_key_id, messages.provider, messages.model, messages.provider_message_id, messages.meta, messages.prompt_tokens, messages.completion_tokens, messages.total_tokens, messages.citations, messages.sequence, messages.created_at 
FROM messages 
WHERE messages.thread_id = $1::VARCHAR ORDER BY messages.sequence
2025-12-06 12:09:24,853 INFO sqlalchemy.engine.Engine [cached since 56.77s ago] ('c47d490a-a4de-4dc0-9d06-5f8a0f4d650b',)
INFO:     127.0.0.1:52345 - "GET /api/threads/?limit=50&archived=true HTTP/1.1" 200 OK
2025-12-06 12:09:24,928 INFO sqlalchemy.engine.Engine ROLLBACK
INFO:     127.0.0.1:52347 - "GET /api/threads/?limit=50&archived=false HTTP/1.1" 200 OK
2025-12-06 12:09:24,987 INFO sqlalchemy.engine.Engine ROLLBACK
2025-12-06 12:09:24,990 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-12-06 12:09:24,990 INFO sqlalchemy.engine.Engine SET LOCAL app.current_org_id = 'org_demo'
2025-12-06 12:09:24,990 INFO sqlalchemy.engine.Engine [cached since 787.9s ago] ()
2025-12-06 12:09:24,991 INFO sqlalchemy.engine.Engine SELECT threads.id, threads.org_id, threads.creator_id, threads.title, threads.description, threads.last_message_preview, threads.pinned, threads.archived, threads.archived_at, threads.settings, threads.last_provider, threads.last_model, threads.created_at, threads.updated_at 
FROM threads 
WHERE threads.org_id = $1::VARCHAR AND threads.archived = false ORDER BY threads.updated_at DESC NULLS LAST, threads.created_at DESC 
 LIMIT $2::INTEGER
2025-12-06 12:09:24,991 INFO sqlalchemy.engine.Engine [cached since 58.12s ago] ('org_demo', 50)
[CTX] build_contextual_messages called with thread_id='c47d490a-a4de-4dc0-9d06-5f8a0f4d650b', type=str
[CTX] _load_short_term_history called with thread_id='c47d490a-a4de-4dc0-9d06-5f8a0f4d650b', type=str
[CTX] Attempting to load from in-memory thread storage...
[THREAD_STORE] get_thread: id='c47d490a-a4de-4dc0-9d06-5f8a0f4d650b', exists=False, obj_id=None, turns=0
[THREAD_STORE] get_history: no thread for id='c47d490a-a4de-4dc0-9d06-5f8a0f4d650b'
[CTX] get_history returned 0 turns for thread_id='c47d490a-a4de-4dc0-9d06-5f8a0f4d650b'
[CTX] No history found for thread_id='c47d490a-a4de-4dc0-9d06-5f8a0f4d650b' (thread may not exist or has no turns)
2025-12-06 12:09:25,160 INFO sqlalchemy.engine.Engine SELECT messages.id, messages.thread_id, messages.user_id, messages.role, messages.content, messages.encrypted_content, messages.encryption_key_id, messages.provider, messages.model, messages.provider_message_id, messages.meta, messages.prompt_tokens, messages.completion_tokens, messages.total_tokens, messages.citations, messages.sequence, messages.created_at 
FROM messages 
WHERE messages.thread_id = $1::VARCHAR ORDER BY messages.sequence DESC 
 LIMIT $2::INTEGER
2025-12-06 12:09:25,160 INFO sqlalchemy.engine.Engine [cached since 1.308s ago] ('c47d490a-a4de-4dc0-9d06-5f8a0f4d650b', 20)
INFO:     127.0.0.1:52345 - "GET /api/threads/?limit=50&archived=false HTTP/1.1" 200 OK
2025-12-06 12:09:25,161 INFO sqlalchemy.engine.Engine ROLLBACK
‚ö†Ô∏è  No messages found in DB for thread c47d490a-a4de-4dc0-9d06-5f8a0f4d650b
‚ö†Ô∏è  No conversation history available for thread c47d490a-a4de-4dc0-9d06-5f8a0f4d650b, starting fresh
üìö Loaded 0 validated history messages
[CTX] Conversation history turns: 0 (before adding current user message)
[CTX] Memory retrieval disabled (memory_enabled=False)

================================================================================
üîß CONTEXT BUILDER: thread_id=c47d490a-a4de-4dc0-9d06-5f8a0f4d650b
================================================================================
Short-term history turns: 0
Memory snippet present: False
Query rewritten: False
Is ambiguous: False
Total messages: 2
System messages: 1
Conversation history turns: 1

Messages array preview:
  [0] system: You are **Syntra**, a multi-model reasoning engine designed for high-speed intent detection, structured internal reasoni...
  [1] user: Original user message:
what is gdpr

Conversation history summary:
================================================================================


================================================================================
üì§ SENDING TO PROVIDER (non-streaming): perplexity/sonar
================================================================================
Using centralized context builder ‚úì
Total messages: 2
Conversation history turns: 0
Memory snippet present: False
Query rewritten: False

Messages preview (first 120 chars each):
  [0] system: You are **Syntra**, a multi-model reasoning engine designed for high-speed intent detection, structured internal reasoni...
  [1] user: Original user message:
what is gdpr
================================================================================

2025-12-06 12:09:25,166 INFO sqlalchemy.engine.Engine SELECT provider_keys.id, provider_keys.org_id, provider_keys.provider, provider_keys.encrypted_key, provider_keys.key_name, provider_keys.last_used, provider_keys.is_active, provider_keys.created_at, provider_keys.updated_at 
FROM provider_keys 
WHERE provider_keys.org_id = $1::VARCHAR AND provider_keys.provider = $2::provider_type AND provider_keys.is_active = $3::VARCHAR
2025-12-06 12:09:25,167 INFO sqlalchemy.engine.Engine [generated in 0.00156s] ('org_demo', 'perplexity', 'true')
INFO:     127.0.0.1:52341 - "GET /api/threads/c47d490a-a4de-4dc0-9d06-5f8a0f4d650b HTTP/1.1" 200 OK
2025-12-06 12:09:25,343 INFO sqlalchemy.engine.Engine ROLLBACK
[NORMAL MODE] provider=perplexity model=sonar finish_reason=None prompt_tokens=1322 completion_tokens=357 total_tokens=1679 content_length=1795
2025-12-06 12:09:32,912 INFO sqlalchemy.engine.Engine SELECT max(messages.sequence) AS max_1 
FROM messages 
WHERE messages.thread_id = $1::VARCHAR
2025-12-06 12:09:32,920 INFO sqlalchemy.engine.Engine [generated in 0.01004s] ('c47d490a-a4de-4dc0-9d06-5f8a0f4d650b',)
2025-12-06 12:09:34,684 INFO sqlalchemy.engine.Engine INSERT INTO messages (id, thread_id, user_id, role, content, encrypted_content, encryption_key_id, provider, model, provider_message_id, prompt_tokens, completion_tokens, total_tokens, sequence) VALUES ($1::VARCHAR, $2::VARCHAR, $3::VARCHAR, $4::message_role, $5::VARCHAR, $6::BYTEA, $7::VARCHAR, $8::VARCHAR, $9::VARCHAR, $10::VARCHAR, $11::INTEGER, $12::INTEGER, $13::INTEGER, $14::INTEGER) RETURNING messages.created_at
2025-12-06 12:09:34,689 INFO sqlalchemy.engine.Engine [generated in 0.00660s] ('6e3936b2-29fc-441d-ad1f-e780bea26299', 'c47d490a-a4de-4dc0-9d06-5f8a0f4d650b', None, 'user', 'what is gdpr', None, None, None, None, None, None, None, None, 0)
2025-12-06 12:09:35,349 INFO sqlalchemy.engine.Engine INSERT INTO messages (id, thread_id, user_id, role, content, encrypted_content, encryption_key_id, provider, model, provider_message_id, meta, prompt_tokens, completion_tokens, total_tokens, citations, sequence) VALUES ($1::VARCHAR, $2::VARCHAR, $3::VARCHAR, $4::message_role, $5::VARCHAR, $6::BYTEA, $7::VARCHAR, $8::VARCHAR, $9::VARCHAR, $10::VARCHAR, $11::JSON, $12::INTEGER, $13::INTEGER, $14::INTEGER, $15::JSON, $16::INTEGER) RETURNING messages.created_at
2025-12-06 12:09:35,349 INFO sqlalchemy.engine.Engine [generated in 0.00173s] ('202e2a89-2f58-478f-86ad-1892c79974a6', 'c47d490a-a4de-4dc0-9d06-5f8a0f4d650b', None, 'assistant', "The **GDPR (General Data Protection Regulation)** is a comprehensive data privacy law enacted by the European Union that governs how personal data of ... (1456 characters truncated) ... s designed to protect EU residents' personal data privacy and strengthen their control over how their information is used by organizations worldwide.", None, None, 'perplexity', 'sonar', None, '{"latency_ms": 7293.03, "request_id": null}', 1322, 357, 1679, '["https://www.cloudflare.com/learning/privacy/what-is-the-gdpr/", "https://gdpr-info.eu/art-4-gdpr/", "https://en.wikipedia.org/wiki/General_Data_Pro ... (45 characters truncated) ... ducts/cloud/compliance/gdpr", "https://gdpr.eu/what-is-gdpr/", "https://www.hrpo.pitt.edu/european-union-eu-general-data-protection-regulation-gdpr"]', 1)
2025-12-06 12:09:35,432 INFO sqlalchemy.engine.Engine SELECT threads.id, threads.org_id, threads.creator_id, threads.title, threads.description, threads.last_message_preview, threads.pinned, threads.archived, threads.archived_at, threads.settings, threads.last_provider, threads.last_model, threads.created_at, threads.updated_at 
FROM threads 
WHERE threads.id = $1::VARCHAR
2025-12-06 12:09:35,432 INFO sqlalchemy.engine.Engine [generated in 0.00015s] ('c47d490a-a4de-4dc0-9d06-5f8a0f4d650b',)
2025-12-06 12:09:35,462 INFO sqlalchemy.engine.Engine UPDATE threads SET last_message_preview=$1::VARCHAR, last_provider=$2::VARCHAR, last_model=$3::VARCHAR, updated_at=now() WHERE threads.id = $4::VARCHAR
2025-12-06 12:09:35,462 INFO sqlalchemy.engine.Engine [generated in 0.00016s] ('what is gdpr', 'perplexity', 'sonar', 'c47d490a-a4de-4dc0-9d06-5f8a0f4d650b')
2025-12-06 12:09:36,494 INFO sqlalchemy.engine.Engine INSERT INTO audit_logs (id, thread_id, message_id, user_id, provider, model, reason, fragments_included, fragments_excluded, scope, package_hash, response_hash, prompt_tokens, completion_tokens, total_tokens) VALUES ($1::VARCHAR, $2::VARCHAR, $3::VARCHAR, $4::VARCHAR, $5::VARCHAR, $6::VARCHAR, $7::VARCHAR, $8::JSON, $9::JSON, $10::VARCHAR, $11::VARCHAR, $12::VARCHAR, $13::INTEGER, $14::INTEGER, $15::INTEGER) RETURNING audit_logs.created_at
2025-12-06 12:09:36,495 INFO sqlalchemy.engine.Engine [generated in 0.00177s] ('26503b21-626b-4645-8adb-893444e9e483', 'c47d490a-a4de-4dc0-9d06-5f8a0f4d650b', '202e2a89-2f58-478f-86ad-1892c79974a6', None, 'perplexity', 'sonar', 'Factual query - Perplexity Sonar provides real-time web search', '[]', '[]', 'private', 'ea6def663734ea477c4522c7e439f0a7bc5830fee111bc6b0772df757b3c0046', '00e645902d3ab1a08d362c82b8703667433c30ac5f6f42cd8dd95fc66880b964', 1322, 357, 1679)
2025-12-06 12:09:36,567 INFO sqlalchemy.engine.Engine COMMIT
2025-12-06 12:09:36,682 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-12-06 12:09:36,684 INFO sqlalchemy.engine.Engine SELECT messages.id, messages.thread_id, messages.user_id, messages.role, messages.content, messages.encrypted_content, messages.encryption_key_id, messages.provider, messages.model, messages.provider_message_id, messages.meta, messages.prompt_tokens, messages.completion_tokens, messages.total_tokens, messages.citations, messages.sequence, messages.created_at 
FROM messages 
WHERE messages.id = $1::VARCHAR
2025-12-06 12:09:36,684 INFO sqlalchemy.engine.Engine [generated in 0.00116s] ('6e3936b2-29fc-441d-ad1f-e780bea26299',)
2025-12-06 12:09:37,102 INFO sqlalchemy.engine.Engine SELECT messages.id, messages.thread_id, messages.user_id, messages.role, messages.content, messages.encrypted_content, messages.encryption_key_id, messages.provider, messages.model, messages.provider_message_id, messages.meta, messages.prompt_tokens, messages.completion_tokens, messages.total_tokens, messages.citations, messages.sequence, messages.created_at 
FROM messages 
WHERE messages.id = $1::VARCHAR
2025-12-06 12:09:37,102 INFO sqlalchemy.engine.Engine [cached since 0.4192s ago] ('202e2a89-2f58-478f-86ad-1892c79974a6',)
[THREAD_STORE] get_or_create_thread: NEW id='c47d490a-a4de-4dc0-9d06-5f8a0f4d650b', obj_id=4610571440
[THREAD_STORE] add_turn BEFORE: id='c47d490a-a4de-4dc0-9d06-5f8a0f4d650b', obj_id=4610571440, len(turns)=0
[THREAD_STORE] add_turn AFTER: id='c47d490a-a4de-4dc0-9d06-5f8a0f4d650b', obj_id=4610571440, len(turns)=1
[THREAD_STORE] get_or_create_thread: existing id='c47d490a-a4de-4dc0-9d06-5f8a0f4d650b', obj_id=4610571440, turns=1
[THREAD_STORE] add_turn BEFORE: id='c47d490a-a4de-4dc0-9d06-5f8a0f4d650b', obj_id=4610571440, len(turns)=1
[THREAD_STORE] add_turn AFTER: id='c47d490a-a4de-4dc0-9d06-5f8a0f4d650b', obj_id=4610571440, len(turns)=2
‚úÖ Added turns to in-memory store for thread c47d490a-a4de-4dc0-9d06-5f8a0f4d650b
‚ö†Ô∏è  TTFT target missed: 7.32s (target: ‚â§1.5s)
‚ö†Ô∏è  Latency P95 target missed: 11.81s (target: ‚â§6s)
INFO:     127.0.0.1:52333 - "POST /api/threads/c47d490a-a4de-4dc0-9d06-5f8a0f4d650b/messages HTTP/1.1" 200 OK
2025-12-06 12:09:37,173 INFO sqlalchemy.engine.Engine ROLLBACK
INFO:     127.0.0.1:52440 - "GET /api/threads?limit=50&archived=false HTTP/1.1" 307 Temporary Redirect
INFO:     127.0.0.1:52442 - "GET /api/threads?limit=50&archived=true HTTP/1.1" 307 Temporary Redirect
INFO:     127.0.0.1:52446 - "GET /api/threads?limit=50&archived=false HTTP/1.1" 307 Temporary Redirect
INFO:     127.0.0.1:52448 - "GET /api/threads?limit=50&archived=true HTTP/1.1" 307 Temporary Redirect
/Users/kanavkhurana/Desktop/Syntra.ai/Syntra.ai/backend/venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2291: RuntimeWarning: coroutine 'get_api_key_for_org' was never awaited
  def execute(
RuntimeWarning: Enable tracemalloc to get the object allocation traceback
2025-12-06 12:25:15,705 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-12-06 12:25:15,712 INFO sqlalchemy.engine.Engine SET LOCAL app.current_org_id = 'org_demo'
2025-12-06 12:25:15,716 INFO sqlalchemy.engine.Engine [cached since 1017s ago] ()
2025-12-06 12:25:15,719 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-12-06 12:25:15,720 INFO sqlalchemy.engine.Engine SET LOCAL app.current_org_id = 'org_demo'
2025-12-06 12:25:15,720 INFO sqlalchemy.engine.Engine [cached since 1017s ago] ()
2025-12-06 12:25:15,735 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-12-06 12:25:15,747 INFO sqlalchemy.engine.Engine SET LOCAL app.current_org_id = 'org_demo'
2025-12-06 12:25:15,747 INFO sqlalchemy.engine.Engine [cached since 1017s ago] ()
2025-12-06 12:25:15,807 INFO sqlalchemy.engine.Engine SELECT threads.id, threads.org_id, threads.creator_id, threads.title, threads.description, threads.last_message_preview, threads.pinned, threads.archived, threads.archived_at, threads.settings, threads.last_provider, threads.last_model, threads.created_at, threads.updated_at 
FROM threads 
WHERE threads.org_id = $1::VARCHAR AND threads.archived = false ORDER BY threads.updated_at DESC NULLS LAST, threads.created_at DESC 
 LIMIT $2::INTEGER
2025-12-06 12:25:15,808 INFO sqlalchemy.engine.Engine [cached since 286.9s ago] ('org_demo', 50)
2025-12-06 12:25:15,809 INFO sqlalchemy.engine.Engine SELECT threads.id, threads.org_id, threads.creator_id, threads.title, threads.description, threads.last_message_preview, threads.pinned, threads.archived, threads.archived_at, threads.settings, threads.last_provider, threads.last_model, threads.created_at, threads.updated_at 
FROM threads 
WHERE threads.id = $1::VARCHAR AND threads.org_id = $2::VARCHAR
2025-12-06 12:25:15,809 INFO sqlalchemy.engine.Engine [cached since 288s ago] ('229d353c-64d4-4f0e-bdbd-56d44878d0fb', 'org_demo')
2025-12-06 12:25:15,809 INFO sqlalchemy.engine.Engine SELECT threads.id, threads.org_id, threads.creator_id, threads.title, threads.description, threads.last_message_preview, threads.pinned, threads.archived, threads.archived_at, threads.settings, threads.last_provider, threads.last_model, threads.created_at, threads.updated_at 
FROM threads 
WHERE threads.org_id = $1::VARCHAR AND threads.archived = true ORDER BY threads.updated_at DESC NULLS LAST, threads.created_at DESC 
 LIMIT $2::INTEGER
2025-12-06 12:25:15,809 INFO sqlalchemy.engine.Engine [cached since 286.9s ago] ('org_demo', 50)
2025-12-06 12:25:16,514 INFO sqlalchemy.engine.Engine SELECT messages.id, messages.thread_id, messages.user_id, messages.role, messages.content, messages.encrypted_content, messages.encryption_key_id, messages.provider, messages.model, messages.provider_message_id, messages.meta, messages.prompt_tokens, messages.completion_tokens, messages.total_tokens, messages.citations, messages.sequence, messages.created_at 
FROM messages 
WHERE messages.thread_id = $1::VARCHAR ORDER BY messages.sequence
2025-12-06 12:25:16,522 INFO sqlalchemy.engine.Engine [cached since 286.4s ago] ('229d353c-64d4-4f0e-bdbd-56d44878d0fb',)
INFO:     127.0.0.1:52448 - "GET /api/threads/?limit=50&archived=false HTTP/1.1" 200 OK
INFO:     127.0.0.1:52446 - "GET /api/threads/?limit=50&archived=true HTTP/1.1" 200 OK
2025-12-06 12:25:16,528 INFO sqlalchemy.engine.Engine ROLLBACK
2025-12-06 12:25:16,529 INFO sqlalchemy.engine.Engine ROLLBACK
INFO:     127.0.0.1:52444 - "GET /api/threads/229d353c-64d4-4f0e-bdbd-56d44878d0fb HTTP/1.1" 200 OK
2025-12-06 12:25:16,633 INFO sqlalchemy.engine.Engine ROLLBACK
2025-12-06 12:25:17,059 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-12-06 12:25:17,064 INFO sqlalchemy.engine.Engine SET LOCAL app.current_org_id = 'org_demo'
2025-12-06 12:25:17,064 INFO sqlalchemy.engine.Engine [cached since 1018s ago] ()
2025-12-06 12:25:17,109 INFO sqlalchemy.engine.Engine SELECT threads.id, threads.org_id, threads.creator_id, threads.title, threads.description, threads.last_message_preview, threads.pinned, threads.archived, threads.archived_at, threads.settings, threads.last_provider, threads.last_model, threads.created_at, threads.updated_at 
FROM threads 
WHERE threads.org_id = $1::VARCHAR AND threads.archived = true ORDER BY threads.updated_at DESC NULLS LAST, threads.created_at DESC 
 LIMIT $2::INTEGER
2025-12-06 12:25:17,110 INFO sqlalchemy.engine.Engine [cached since 288.2s ago] ('org_demo', 50)
INFO:     127.0.0.1:52440 - "GET /api/threads/?limit=50&archived=true HTTP/1.1" 200 OK
2025-12-06 12:25:17,389 INFO sqlalchemy.engine.Engine ROLLBACK
2025-12-06 12:25:17,458 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-12-06 12:25:17,459 INFO sqlalchemy.engine.Engine SET LOCAL app.current_org_id = 'org_demo'
2025-12-06 12:25:17,459 INFO sqlalchemy.engine.Engine [cached since 1018s ago] ()
2025-12-06 12:25:17,523 INFO sqlalchemy.engine.Engine SELECT threads.id, threads.org_id, threads.creator_id, threads.title, threads.description, threads.last_message_preview, threads.pinned, threads.archived, threads.archived_at, threads.settings, threads.last_provider, threads.last_model, threads.created_at, threads.updated_at 
FROM threads 
WHERE threads.org_id = $1::VARCHAR AND threads.archived = false ORDER BY threads.updated_at DESC NULLS LAST, threads.created_at DESC 
 LIMIT $2::INTEGER
2025-12-06 12:25:17,523 INFO sqlalchemy.engine.Engine [cached since 288.6s ago] ('org_demo', 50)
INFO:     127.0.0.1:52442 - "GET /api/threads/?limit=50&archived=false HTTP/1.1" 200 OK
2025-12-06 12:25:17,662 INFO sqlalchemy.engine.Engine ROLLBACK
INFO:     127.0.0.1:52442 - "GET /api/threads?limit=50&archived=false HTTP/1.1" 307 Temporary Redirect
INFO:     127.0.0.1:52440 - "GET /api/threads?limit=50&archived=true HTTP/1.1" 307 Temporary Redirect
INFO:     127.0.0.1:52446 - "GET /api/threads?limit=50&archived=false HTTP/1.1" 307 Temporary Redirect
INFO:     127.0.0.1:52448 - "GET /api/threads?limit=50&archived=true HTTP/1.1" 307 Temporary Redirect
2025-12-06 12:25:20,101 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-12-06 12:25:20,102 INFO sqlalchemy.engine.Engine SET LOCAL app.current_org_id = 'org_demo'
2025-12-06 12:25:20,102 INFO sqlalchemy.engine.Engine [cached since 1021s ago] ()
2025-12-06 12:25:20,116 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-12-06 12:25:20,117 INFO sqlalchemy.engine.Engine SET LOCAL app.current_org_id = 'org_demo'
2025-12-06 12:25:20,117 INFO sqlalchemy.engine.Engine [cached since 1021s ago] ()
2025-12-06 12:25:20,132 INFO sqlalchemy.engine.Engine SELECT threads.id, threads.org_id, threads.creator_id, threads.title, threads.description, threads.last_message_preview, threads.pinned, threads.archived, threads.archived_at, threads.settings, threads.last_provider, threads.last_model, threads.created_at, threads.updated_at 
FROM threads 
WHERE threads.org_id = $1::VARCHAR AND threads.archived = true ORDER BY threads.updated_at DESC NULLS LAST, threads.created_at DESC 
 LIMIT $2::INTEGER
2025-12-06 12:25:20,132 INFO sqlalchemy.engine.Engine [cached since 291.3s ago] ('org_demo', 50)
2025-12-06 12:25:20,144 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-12-06 12:25:20,144 INFO sqlalchemy.engine.Engine SET LOCAL app.current_org_id = 'org_demo'
2025-12-06 12:25:20,144 INFO sqlalchemy.engine.Engine [cached since 1021s ago] ()
2025-12-06 12:25:20,168 INFO sqlalchemy.engine.Engine SELECT threads.id, threads.org_id, threads.creator_id, threads.title, threads.description, threads.last_message_preview, threads.pinned, threads.archived, threads.archived_at, threads.settings, threads.last_provider, threads.last_model, threads.created_at, threads.updated_at 
FROM threads 
WHERE threads.org_id = $1::VARCHAR AND threads.archived = false ORDER BY threads.updated_at DESC NULLS LAST, threads.created_at DESC 
 LIMIT $2::INTEGER
2025-12-06 12:25:20,168 INFO sqlalchemy.engine.Engine [cached since 291.3s ago] ('org_demo', 50)
2025-12-06 12:25:20,180 INFO sqlalchemy.engine.Engine SELECT threads.id, threads.org_id, threads.creator_id, threads.title, threads.description, threads.last_message_preview, threads.pinned, threads.archived, threads.archived_at, threads.settings, threads.last_provider, threads.last_model, threads.created_at, threads.updated_at 
FROM threads 
WHERE threads.id = $1::VARCHAR AND threads.org_id = $2::VARCHAR
2025-12-06 12:25:20,181 INFO sqlalchemy.engine.Engine [cached since 292.3s ago] ('c47d490a-a4de-4dc0-9d06-5f8a0f4d650b', 'org_demo')
INFO:     127.0.0.1:52446 - "GET /api/threads/?limit=50&archived=true HTTP/1.1" 200 OK
2025-12-06 12:25:20,212 INFO sqlalchemy.engine.Engine ROLLBACK
2025-12-06 12:25:20,214 INFO sqlalchemy.engine.Engine SELECT messages.id, messages.thread_id, messages.user_id, messages.role, messages.content, messages.encrypted_content, messages.encryption_key_id, messages.provider, messages.model, messages.provider_message_id, messages.meta, messages.prompt_tokens, messages.completion_tokens, messages.total_tokens, messages.citations, messages.sequence, messages.created_at 
FROM messages 
WHERE messages.thread_id = $1::VARCHAR ORDER BY messages.sequence
2025-12-06 12:25:20,214 INFO sqlalchemy.engine.Engine [cached since 290.1s ago] ('c47d490a-a4de-4dc0-9d06-5f8a0f4d650b',)
2025-12-06 12:25:20,216 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-12-06 12:25:20,216 INFO sqlalchemy.engine.Engine SET LOCAL app.current_org_id = 'org_demo'
2025-12-06 12:25:20,216 INFO sqlalchemy.engine.Engine [cached since 1021s ago] ()
2025-12-06 12:25:20,238 INFO sqlalchemy.engine.Engine SELECT threads.id, threads.org_id, threads.creator_id, threads.title, threads.description, threads.last_message_preview, threads.pinned, threads.archived, threads.archived_at, threads.settings, threads.last_provider, threads.last_model, threads.created_at, threads.updated_at 
FROM threads 
WHERE threads.org_id = $1::VARCHAR AND threads.archived = true ORDER BY threads.updated_at DESC NULLS LAST, threads.created_at DESC 
 LIMIT $2::INTEGER
2025-12-06 12:25:20,238 INFO sqlalchemy.engine.Engine [cached since 291.4s ago] ('org_demo', 50)
INFO:     127.0.0.1:52448 - "GET /api/threads/?limit=50&archived=false HTTP/1.1" 200 OK
2025-12-06 12:25:20,260 INFO sqlalchemy.engine.Engine ROLLBACK
2025-12-06 12:25:20,268 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-12-06 12:25:20,268 INFO sqlalchemy.engine.Engine SET LOCAL app.current_org_id = 'org_demo'
2025-12-06 12:25:20,268 INFO sqlalchemy.engine.Engine [cached since 1021s ago] ()
2025-12-06 12:25:20,269 INFO sqlalchemy.engine.Engine SELECT threads.id, threads.org_id, threads.creator_id, threads.title, threads.description, threads.last_message_preview, threads.pinned, threads.archived, threads.archived_at, threads.settings, threads.last_provider, threads.last_model, threads.created_at, threads.updated_at 
FROM threads 
WHERE threads.org_id = $1::VARCHAR AND threads.archived = false ORDER BY threads.updated_at DESC NULLS LAST, threads.created_at DESC 
 LIMIT $2::INTEGER
2025-12-06 12:25:20,269 INFO sqlalchemy.engine.Engine [cached since 291.4s ago] ('org_demo', 50)
INFO:     127.0.0.1:52446 - "GET /api/threads/?limit=50&archived=false HTTP/1.1" 200 OK
2025-12-06 12:25:20,271 INFO sqlalchemy.engine.Engine ROLLBACK
INFO:     127.0.0.1:52440 - "GET /api/threads/?limit=50&archived=true HTTP/1.1" 200 OK
2025-12-06 12:25:20,303 INFO sqlalchemy.engine.Engine ROLLBACK
INFO:     127.0.0.1:52444 - "GET /api/threads/c47d490a-a4de-4dc0-9d06-5f8a0f4d650b HTTP/1.1" 200 OK
2025-12-06 12:25:20,416 INFO sqlalchemy.engine.Engine ROLLBACK
