INFO:     Will watch for changes in these directories: ['/Users/rao305/Documents/Syntra/backend']
INFO:     Uvicorn running on http://127.0.0.1:8000 (Press CTRL+C to quit)
INFO:     Started reloader process [79142] using WatchFiles
/Users/rao305/Documents/Syntra/backend/venv/lib/python3.9/site-packages/urllib3/__init__.py:35: NotOpenSSLWarning: urllib3 v2 only supports OpenSSL 1.1.1+, currently the 'ssl' module is compiled with 'LibreSSL 2.8.3'. See: https://github.com/urllib3/urllib3/issues/3020
  warnings.warn(
INFO:     Started server process [79149]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
Warning: OpenTelemetry not available (install opentelemetry packages)
INFO:     127.0.0.1:57647 - "GET /health HTTP/1.1" 200 OK
[THREAD_STORE] get_thread: id='e5282065-8e31-46fe-a041-646abe050565', exists=False, obj_id=None, turns=0
[THREAD_STORE] get_history: no thread for id='e5282065-8e31-46fe-a041-646abe050565'
üîç Checking history for previous AI message. Found 0 turns
‚ö†Ô∏è  No previous assistant message found in history
‚ÑπÔ∏è  No media generation intent detected for: Add a P0 level above P1 because we need 'critical-...
[THREAD_STORE] get_thread: id='e5282065-8e31-46fe-a041-646abe050565', exists=False, obj_id=None, turns=0
[THREAD_STORE] get_history: no thread for id='e5282065-8e31-46fe-a041-646abe050565'
‚úèÔ∏è  LLM rewrite: Add a P0 level above P1 because we need 'critical-... ‚Üí Add a P0 level above P1 because the team needs a '...
   Reasoning: I replaced the pronoun 'we' with 'the team' to clarify who needs the 'critical-critical' priority level.
‚úèÔ∏è  LLM rewrite: Add a P0 level above P1 because we need 'critical-... ‚Üí Add a P0 level above P1 because the team needs a '...
   Reasoning: 
‚ö° Provider selected in 9ms -> perplexity/sonar
üìù LLM context-aware rewrite: 'Add a P0 level above P1 because we need 'critical-critical'....' ‚Üí 'Add a P0 level above P1 because the team needs a 'critical-critical' priority le...'
[CTX] build_contextual_messages called with thread_id='e5282065-8e31-46fe-a041-646abe050565', type=str
[CTX] _load_short_term_history called with thread_id='e5282065-8e31-46fe-a041-646abe050565', type=str
[CTX] Attempting to load from in-memory thread storage...
[THREAD_STORE] get_thread: id='e5282065-8e31-46fe-a041-646abe050565', exists=False, obj_id=None, turns=0
[THREAD_STORE] get_history: no thread for id='e5282065-8e31-46fe-a041-646abe050565'
[CTX] get_history returned 0 turns for thread_id='e5282065-8e31-46fe-a041-646abe050565'
[CTX] No history found for thread_id='e5282065-8e31-46fe-a041-646abe050565' (thread may not exist or has no turns)
‚úÖ Loaded 6 messages from database (attempt 1)
[THREAD_STORE] get_thread: id='e5282065-8e31-46fe-a041-646abe050565', exists=False, obj_id=None, turns=0
[THREAD_STORE] get_or_create_thread: NEW id='e5282065-8e31-46fe-a041-646abe050565', obj_id=5532464992
[THREAD_STORE] add_turn BEFORE: id='e5282065-8e31-46fe-a041-646abe050565', obj_id=5532464992, len(turns)=0
[THREAD_STORE] add_turn AFTER: id='e5282065-8e31-46fe-a041-646abe050565', obj_id=5532464992, len(turns)=1
[THREAD_STORE] get_or_create_thread: existing id='e5282065-8e31-46fe-a041-646abe050565', obj_id=5532464992, turns=1
[THREAD_STORE] add_turn BEFORE: id='e5282065-8e31-46fe-a041-646abe050565', obj_id=5532464992, len(turns)=1
[THREAD_STORE] add_turn AFTER: id='e5282065-8e31-46fe-a041-646abe050565', obj_id=5532464992, len(turns)=2
[THREAD_STORE] get_or_create_thread: existing id='e5282065-8e31-46fe-a041-646abe050565', obj_id=5532464992, turns=2
[THREAD_STORE] add_turn BEFORE: id='e5282065-8e31-46fe-a041-646abe050565', obj_id=5532464992, len(turns)=2
[THREAD_STORE] add_turn AFTER: id='e5282065-8e31-46fe-a041-646abe050565', obj_id=5532464992, len(turns)=3
[THREAD_STORE] get_or_create_thread: existing id='e5282065-8e31-46fe-a041-646abe050565', obj_id=5532464992, turns=3
[THREAD_STORE] add_turn BEFORE: id='e5282065-8e31-46fe-a041-646abe050565', obj_id=5532464992, len(turns)=3
[THREAD_STORE] add_turn AFTER: id='e5282065-8e31-46fe-a041-646abe050565', obj_id=5532464992, len(turns)=4
[THREAD_STORE] get_or_create_thread: existing id='e5282065-8e31-46fe-a041-646abe050565', obj_id=5532464992, turns=4
[THREAD_STORE] add_turn BEFORE: id='e5282065-8e31-46fe-a041-646abe050565', obj_id=5532464992, len(turns)=4
[THREAD_STORE] add_turn AFTER: id='e5282065-8e31-46fe-a041-646abe050565', obj_id=5532464992, len(turns)=5
[THREAD_STORE] get_or_create_thread: existing id='e5282065-8e31-46fe-a041-646abe050565', obj_id=5532464992, turns=5
[THREAD_STORE] add_turn BEFORE: id='e5282065-8e31-46fe-a041-646abe050565', obj_id=5532464992, len(turns)=5
[THREAD_STORE] add_turn AFTER: id='e5282065-8e31-46fe-a041-646abe050565', obj_id=5532464992, len(turns)=6
üìö Loaded 6 validated history messages
[CTX] Conversation history turns: 6 (before adding current user message)
[CTX] Memory retrieval disabled (memory_enabled=False)

================================================================================
üîß CONTEXT BUILDER: thread_id=e5282065-8e31-46fe-a041-646abe050565
================================================================================
Short-term history turns: 6
Memory snippet present: False
Query rewritten: False
Is ambiguous: False
Total messages: 8
System messages: 1
Conversation history turns: 7

Messages array preview:
  [0] system: You are Syntra. The user is greeting you.

- Respond conversationally in one or two sentences.
- Ask a light, optional f...
  [1] assistant: | Severity | MTTA Target | MTTR Target |
| :------- | :---------- | :---------- |
| **P1**   | 5 minutes   | 1 hour     ...
  [2] user: Add a P0 level above P1 because we need 'critical-critical'.
  [3] user: Based on the taxonomy you just confirmed, draft a minimal severity matrix with MTTA/MTTR targets for P1‚ÄìP3.
  [4] assistant: I will follow this framework.

Allowed Severities: P1, P2, P3
Roles: IC, Comms Lead, On-call Engineer, Eng Manager, Supp...
  [5] assistant: I will follow this framework.

**Allowed Severities:**
*   P1
*   P2
*   P3

**Involved Roles:**
*   Individual Contribu...
  [6] user: We are defining an incident severity framework. Use ONLY P1, P2, P3 (no other severities). Roles are IC, Comms Lead, On-...
  [7] user: Original user message:
Add a P0 level above P1 because the team needs a 'critical-critical' priority level.

Conversation history summary:
  [0] user: Add a P0 level above P1 because we need 'critical-critical'.
  [1] user: Based on the taxonomy you just confirmed, draft a minimal severity matrix with M...
  [2] assistant: I will follow this framework.

Allowed Severities: P1, P2, P3
Roles: IC, Comms L...
  [3] assistant: I will follow this framework.

**Allowed Severities:**
*   P1
*   P2
*   P3

**I...
  [4] user: We are defining an incident severity framework. Use ONLY P1, P2, P3 (no other se...
================================================================================


================================================================================
üì§ SENDING TO PROVIDER: perplexity/sonar
================================================================================
Using centralized context builder ‚úì
Total messages: 8
Conversation history turns: 6
Memory snippet present: False
Query rewritten: False

Messages preview (first 120 chars each):
  [0] system: You are Syntra. The user is greeting you.

- Respond conversationally in one or two sentences.
- Ask a light, optional f...
  [1] assistant: | Severity | MTTA Target | MTTR Target |
| :------- | :---------- | :---------- |
| **P1**   | 5 minutes   | 1 hour     ...
  [2] user: Add a P0 level above P1 because we need 'critical-critical'.
  [3] user: Based on the taxonomy you just confirmed, draft a minimal severity matrix with MTTA/MTTR targets for P1‚ÄìP3.
  [4] assistant: I will follow this framework.

Allowed Severities: P1, P2, P3
Roles: IC, Comms Lead, On-call Engineer, Eng Manager, Supp...
  [5] assistant: I will follow this framework.

**Allowed Severities:**
*   P1
*   P2
*   P3

**Involved Roles:**
*   Individual Contribu...
  [6] user: We are defining an incident severity framework. Use ONLY P1, P2, P3 (no other severities). Roles are IC, Comms Lead, On-...
  [7] user: Original user message:
Add a P0 level above P1 because the team needs a 'critical-critical' priority level.
================================================================================

‚ö° Memory + prompt built in 78ms
‚ö†Ô∏è  No env var for perplexity, fetching from DB...
‚ö° DB fetch done in 14ms
‚ö° TOTAL SETUP TIME: 92ms - Starting provider stream NOW...
‚ÑπÔ∏è  User message already exists in database, skipping duplicate save
INFO:     127.0.0.1:57678 - "POST /api/threads/e5282065-8e31-46fe-a041-646abe050565/messages/stream HTTP/1.1" 200 OK
[THREAD_STORE] get_or_create_thread: existing id='e5282065-8e31-46fe-a041-646abe050565', obj_id=5532464992, turns=6
[THREAD_STORE] add_turn BEFORE: id='e5282065-8e31-46fe-a041-646abe050565', obj_id=5532464992, len(turns)=6
[THREAD_STORE] add_turn AFTER: id='e5282065-8e31-46fe-a041-646abe050565', obj_id=5532464992, len(turns)=7
üíæ Added user message to in-memory thread storage IMMEDIATELY (for next request context)
‚ö° Starting provider stream for perplexity/sonar...
‚ùå Provider adapter error: Client error '400 Bad Request' for url 'https://api.perplexity.ai/chat/completions'
For more information check: https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/400
Traceback (most recent call last):
  File "/Users/rao305/Documents/Syntra/backend/app/api/threads.py", line 1879, in stream_with_background_validation
    async for chunk in call_provider_adapter_streaming(
  File "/Users/rao305/Documents/Syntra/backend/app/services/provider_dispatch.py", line 87, in call_provider_adapter_streaming
    async for chunk in call_perplexity_streaming(messages, model, api_key, max_tokens=max_tokens):
  File "/Users/rao305/Documents/Syntra/backend/app/adapters/perplexity.py", line 102, in call_perplexity_streaming
    response.raise_for_status()
  File "/Users/rao305/Documents/Syntra/backend/venv/lib/python3.9/site-packages/httpx/_models.py", line 829, in raise_for_status
    raise HTTPStatusError(message, request=request, response=self)
httpx.HTTPStatusError: Client error '400 Bad Request' for url 'https://api.perplexity.ai/chat/completions'
For more information check: https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/400

‚ùå Streaming error: Client error '400 Bad Request' for url 'https://api.perplexity.ai/chat/completions'
For more information check: https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/400
Traceback (most recent call last):
  File "/Users/rao305/Documents/Syntra/backend/app/api/threads.py", line 2139, in event_source
    async for chunk in stream_with_background_validation():
  File "/Users/rao305/Documents/Syntra/backend/app/api/threads.py", line 1879, in stream_with_background_validation
    async for chunk in call_provider_adapter_streaming(
  File "/Users/rao305/Documents/Syntra/backend/app/services/provider_dispatch.py", line 87, in call_provider_adapter_streaming
    async for chunk in call_perplexity_streaming(messages, model, api_key, max_tokens=max_tokens):
  File "/Users/rao305/Documents/Syntra/backend/app/adapters/perplexity.py", line 102, in call_perplexity_streaming
    response.raise_for_status()
  File "/Users/rao305/Documents/Syntra/backend/venv/lib/python3.9/site-packages/httpx/_models.py", line 829, in raise_for_status
    raise HTTPStatusError(message, request=request, response=self)
httpx.HTTPStatusError: Client error '400 Bad Request' for url 'https://api.perplexity.ai/chat/completions'
For more information check: https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/400

INFO:     127.0.0.1:57791 - "GET /health HTTP/1.1" 200 OK
